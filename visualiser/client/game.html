<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./style.css" rel="stylesheet">
    <script src="./util.js" type="text/javascript"></script> 
    <title>Filler game</title>
</head>
<body>
    <h1>Welcome to <span class="uppercase">Filler championship</span></h1>
    <section>
        <div class="flex flexGame">
            <div id="field">{field}</div>
            <div class="infoAndControls flex">
                <div class="score">
                    <div class="scoreWrapper">
                        <span id="playerXname">Player 1</span>
                        <div class="playerScore">
                            <div class="scoreBar X" id="playerX"></div>
                        </div>
                    </div>
                    <div class="scoreWrapper">
                        <span id="playerOname">Player 2</span>
                        <div class="playerScore">
                            <div class="scoreBar O" id="playerO"></div>
                        </div>
                    </div>
                </div>
                <!-- <div class="piece">
                    <span>current piece</span>
                    <div id="currentPiece"></div>
                </div> -->
                <div class="controlPanel">
                    <input class="button control" type="button" id="start" value="Start" />
                    <input class="button control" type="button" id="pause" value="Pause" />
                    <input class="button control" type="button" id="reset" value="Reset" />
                    <input class="button control" type="button" id="stepForward" value="Step forward" />
                    <input class="button control" type="button" id="stepBackward" value="Step backward" />
                </div>
            </div>
        </div>
		<br/>
		<div>
			<a class="button" href="http://localhost:3000">back</a>
		</div>
    </section>
    <footer>
        <span>Handcrafted by akraig</span>
    </footer>
    <script>
        let timerID;

        const updateField = (map) => {
            document.querySelector('#field').innerHTML = getField(map);
        };
        
        const updateScore = (score) => {
            let maxLength = score[0];
            let player1width = score[1] * 100 / maxLength;
            let player2width = score[2] * 100 / maxLength;
            document.querySelector('#playerX').style.width =  `${player1width}%`;
            document.querySelector('#playerO').style.width =  `${player2width}%`;
        };

        const updateState = (state) => {
            log(`state: ${state}`);
            postSettings(JSON.stringify({'state':state}), '/control')
                .then(ok => {
                    log(JSON.parse(ok.response));
                    updateField(JSON.parse(ok.response).map);
                    updateScore(JSON.parse(ok.response).score);
                    log(JSON.parse(ok.response).players);
                    updatePlayers(JSON.parse(ok.response).players);
                })
                .catch(err => {
                    log(`error in start (post): ${err}`);
                    tempAlert(JSON.stringify({status:400}));
                })
        }

        const updatePlayers = (players) => {
            if (players.length == 2) {
                document.querySelector('#playerXname').innerHTML = players[0];
                document.querySelector('#playerOname').innerHTML = players[1];
            }
        }

        const start = () => {
            timerID = setTimeout(() => {
                updateState('start');
            }, 33);
        };

        const pause = () => {
            clearTimeout(timerID);
            updateState('pause');
        }

        /**
         * bug/feature/NOT TESTED:
         * After pressing 'RESET' UI should be able to show some further moves,
         * as long as history stores (with "STEP" buttons).
         * If pressed not too fast - possibly the whole game,
         * because VM is much faster than UI
         */

        const reset = () => {
            clearTimeout(timerID);
            updateState('reset');
        }

        const stepForward = () => {
            clearTimeout(timerID);
            updateState('stepForward');
        }

        const stepBackward = () => {
            clearTimeout(timerID);
            updateState('stepBackward');
        }

        updateState('start');
        document.querySelector('#start').onclick = start;
        document.querySelector('#pause').onclick = pause;
        document.querySelector('#reset').onclick = reset;
        document.querySelector('#stepForward').onclick = stepForward;
        document.querySelector('#stepBackward').onclick = stepBackward;
    </script>
</body>
</html>