<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="./style.css" rel="stylesheet">
    <title>Filler settings</title>
</head>
<body>
    <h1>Filler settings</h1>
    <section>
        <form name="settings">
            <label class="uppercase">Player 1</label><br>
            <select type="text" name="player1">
                <!-- TODO: dynamically insert players based on folder's content -->
                <option value="abanlin">abanlin</option>
                <option value="akraig" selected>akraig</option>
                <option value="carli">carli</option>
                <option value="champely">champely</option>
                <option value="grati">grati</option>
                <option value="hcao">hcao</option>
                <option value="hcao">lcharvol</option>
                <option value="hcao">superjeannot</option>
                <option value="hcao">zweng</option>
            </select><br><br>
            <label class="uppercase">Player 2</label><br>
            <select type="text" name="player2">
                <option value="abanlin" selected>abanlin</option>
                <option value="akraig">akraig</option>
                <option value="carli">carli</option>
                <option value="champely">champely</option>
                <option value="grati">grati</option>
                <option value="hcao">hcao</option>
                <option value="hcao">lcharvol</option>
                <option value="hcao">superjeannot</option>
                <option value="hcao">zweng</option>
            </select><br><br>
            <label class="uppercase">Map size</label><br>
            <select type="text" name="map">
                <option selected value="map00">small</option>
                <option value="map01">medium</option>
                <option value="map02">big</option>
            </select><br><br>
            <input class="uppercase button" type="button" id="cancel" value="Cancel" />
            <input class="uppercase button" type="submit" id="submit" value="Save" />
        </form>
    </section>
    <footer>
        <span>Handcrafted by akraig</span>
    </footer>
    <script type="text/javascript">
        document.getElementById("cancel").onclick = () => {
            location.href = "http://localhost:3000/";
        };
        
        function tempAlert(data,duration)
        {
            data = JSON.parse(data);
            console.log(`status: ${data.status}, message: ${data.message}`);
            let status = (data.code > 399) ? 'error' : 'ok';
            var el = document.createElement("div");
            el.setAttribute('class', `tempMessage ${status}`)
            // el.setAttribute("style",`position:absolute;
            //                          bottom:4%;
            //                          left:4%;
            //                          padding: 20px 50px;
            //                          text-align: center;
            //                          background-color:${bgColor};
            //                          color:${textColor}`);
            el.innerHTML = data.message !== undefined ? data.message : 'Error';
            setTimeout(function(){
                el.parentNode.removeChild(el);
            },duration);
            document.body.appendChild(el);
        }

        function postSettings(data) {
            let post = new XMLHttpRequest();
            post.open("POST", "/settings", true);
            post.setRequestHeader("Content-Type", "application/json");
            post.send(data);

            let promise = new Promise((resolve, reject) => {
                post.onload = () => {
                if (post.status >= 200 && post.status < 400) {
                    resolve(post);
                } else {
                    reject(post);
                }
            }
            });
            return promise;
            
            // let post = {
            //     method: 'post',
            //     headers: {
            //         "Content-Type": "application/json"
            //     },
            //     body: data
            // }
            // return fetch('/settings', post);
        }
        

        document.getElementById("submit").addEventListener("click", e => {
             e.preventDefault();
            // получаем данные формы
            let settings = document.forms["settings"];
            let players = [];
            players.push(settings.elements["player1"].value);
            players.push(settings.elements["player2"].value);
            let map = settings.elements["map"].value;
            // сериализуем данные в json
            let data = JSON.stringify({players: players, map: map});
            let result = postSettings(data)
                            .then(ok => {
                                console.log(ok.response);
                                tempAlert(ok.response, 2000);
                            })
                            .then(fetch('/'))
                            .catch(error => {
                                console.log(error.response);
                                tempAlert(error.response, 2000);
                            })
         });
    </script>
</body>
</html>
